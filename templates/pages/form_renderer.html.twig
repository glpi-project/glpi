
{#
 # ---------------------------------------------------------------------
 #
 # GLPI - Gestionnaire Libre de Parc Informatique
 #
 # http://glpi-project.org
 #
 # @copyright 2015-2025 Teclib' and contributors.
 # @copyright 2003-2014 by the INDEPNET Development Team.
 # @licence   https://www.gnu.org/licenses/gpl-3.0.html
 #
 # ---------------------------------------------------------------------
 #
 # LICENSE
 #
 # This file is part of GLPI.
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 #
 # ---------------------------------------------------------------------
 #}

{% extends "layout/page_without_tabs.html.twig" %}

{% set container_size = "narrow" %}

{# TODO: rework this page style to use the standard tabler_title name for the
   form's title #}

{% block content_body %}
    {# Is this a single or multi sections forms ? #}
    {% set is_single_section_form = form.getSections()|length == 1 %}

    <form id="forms_form_answers" method="POST" action="{{ path("/Form/SubmitAnswers") }}">

        <div class="form-renderer mt-n5">

            {# Form header: title and description #}
            <div
                class="mb-4"
                data-glpi-form-renderer-form-header
            >
                <h1 class="form-title mb-2"> {{ form.fields.name }} </h1>

                <div class="text-muted form-description">
                    {{ form.fields.header|safe_html }}
                </div>
            </div>

            {% for section in form.getSections() %}
                {# Is this the first section of a form ? #}
                {% set is_first_section = loop.index0 == 0 %}
                {% set section_index = loop.index0 %}

                <div
                    class="{{ is_first_section ? "" : "d-none" }}"
                    data-glpi-form-renderer-section="{{ section_index }}"
                >
                    {% if not is_single_section_form %}
                        <div
                            class="bg-primary px-2 py-1 rounded-top "
                            style="width: fit-content;"
                        >
                            {{ __("Step %d of %d")|format(loop.index, form.getSections()|length) }}
                        </div>
                    {% endif %}
                    <div
                        class="card mb-3" {{ not is_single_section_form ? "style='border-top-left-radius: 0;'" : "" }}
                    >
                        <div class="card-body">

                            {% if not is_single_section_form %}
                                <h2 class="mb-1 {{ not section.fields.name ? "text-muted" : "" }}">
                                    {{ section.fields.name|default(__('Untitled section')) }}
                                </h2>

                                <div class="text-muted section-description mb-3">
                                    {{ section.fields.description|safe_html }}
                                </div>
                            {% endif %}

                            {% for form_group_blocks in section.getBlocks() %}
                                {# Ensure form_group_blocks is iterable (may be a single question) #}
                                {% if form_group_blocks is not iterable %}
                                    {% set form_group_blocks = [form_group_blocks] %}
                                {% endif %}

                                <section data-glpi-form-renderer-horizontal-blocks>
                                    {% set previous_index = -1 %}
                                    {% for form_block in form_group_blocks %}
                                        {% if form_block.fields.horizontal_rank > previous_index + 1 %}
                                            {% for i in 1..(form_block.fields.horizontal_rank - (previous_index + 1)) %}
                                            <div style="flex: 1;"></div>
                                            {% endfor %}
                                        {% endif %}
                                        {% set previous_index = form_block.fields.horizontal_rank %}

                                        {% if form_block is instanceof('Glpi\\Form\\Question') %}
                                            {% set question_type = form_block.getQuestionType() %}
                                        {% endif %}

                                        {% set skip_question = false %}

                                        {# Skip unknown types (may be a disabled plugin) #}
                                        {% if form_block is instanceof('Glpi\\Form\\Question') and question_type is null %}
                                            {% set skip_question = true %}
                                        {% endif %}

                                        {# Skip questions not allowed for anonymous forms #}
                                        {% if not skip_question and form_block is instanceof('Glpi\\Form\\Question') and unauthenticated_user and not question_type.isAllowedForUnauthenticatedAccess() %}
                                            {% set skip_question = true %}
                                        {% endif %}

                                        {% if not skip_question %}
                                            <section
                                                aria-label="{{ form_block.fields.name }}"
                                                class="{{ is_first_section ? "" : "d-none" }}"
                                                style="flex: 1;"
                                                data-glpi-form-renderer-parent-section="{{ section_index }}"
                                            >
                                                <h3 class="mb-2 {{ not form_block.fields.name ? "text-muted" : "" }}">
                                                    {{ form_block.fields.name|default(__('Untitled question')) }}
                                                    {% if form_block.fields.is_mandatory %}
                                                        <span class="text-danger">*</span>
                                                    {% endif %}
                                                </h3>

                                                {% if form_block is instanceof('Glpi\\Form\\Question') %}
                                                    <div class="mb-2">
                                                        {{ question_type.renderEndUserTemplate(form_block)|raw }}
                                                    </div>
                                                {% endif %}

                                                <div class="text-muted block-description">
                                                    {{ form_block.fields.description|safe_html }}
                                                </div>
                                            </section>
                                        {% endif %}
                                    {% endfor %}
                                </section>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            {% endfor %}

            {# Form reference #}
            <input type="hidden" name="forms_id" value="{{ form.fields.id }}">

            {# Actions #}
            <div class="d-flex justify-content-end" data-glpi-form-renderer-actions>
                <button
                    type="button"
                    data-glpi-form-renderer-action="previous-section"
                    class="btn btn-ghost-secondary d-none me-2"
                >
                    {{ __("Back") }}
                </button>

                <button
                    type="button"
                    data-glpi-form-renderer-action="next-section"
                    class="btn btn-primary {{ is_single_section_form ? "d-none" : "" }}"
                >
                    {{ __("Continue") }}
                </button>

                <button
                    type="button"
                    data-glpi-form-renderer-action="submit"
                    class="btn btn-primary {{ not is_single_section_form ? "d-none" : "" }}"
                    disabled
                >
                    {{ __("Send form") }}
                </button>
            </div>

            {# Final "success" confirmation #}
            <div
                class="empty d-none mt-5"
                data-glpi-form-renderer-success
            >
                <div class="empty-title d-flex align-items-center">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="icon text-green icon-lg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                        <path d="M9 12l2 2l4 -4"></path>
                    </svg>
                    <span class="ms-2"> {{ __("Form submitted") }} </span>
                </div>
                <p class="empty-subtitle text-secondary">
                    {{ __("Your form has been submitted successfully.") }}
                </p>
                <div class="mt-3 d-flex">
                    <a class="btn btn-outline-secondary me-2" href="{{ path('/Helpdesk') }}">
                        <i class="ti ti-home me-1"></i>
                        <span>{{ __("Go home") }}</span>
                    </a>
                    <a class="btn btn-primary" href="{{ path('/front/ticket.php?' ~ my_tickets_url_param) }}">
                        <i class="ti ti-article me-1"></i>
                        <span>{{ __("See my tickets") }}</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token() }}" />

    {# Include direct access token if supplied #}
    {% if token %}
        <input type="hidden" name="token" value="{{ token }}" />
    {% endif %}

    <script>
        import("{{ js_path('js/modules/Forms/RendererController.js') }}").then((m) => {
            new m.GlpiFormRendererController($('#forms_form_answers'));
        });
    </script>

{% endblock content_body %}
