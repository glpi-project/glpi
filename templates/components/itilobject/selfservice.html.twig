{% import "components/form/fields_macros.html.twig" as fields %}

{% set rand = random() %}
{% set base_field_options = {
   'is_horizontal': false,
   'full_width': true,
   'full_width_adapt_column': false,
   'fields_template': itiltemplate,
   'rand': rand,
} %}
{% set right_field_options = base_field_options|merge({
   'is_horizontal': true,
   'label_class': 'col-lg-3',
   'input_class': 'col-lg-9',
}) %}

<div class="container-lg">

   {% if nb_tic_to_validate > 0 %}
      <div class="alert alert-warning" role="alert">
      {{ __('There is some tickets awaiting approval') }} â€” <a href="{{ url_validate|raw }}" class="alert-link">{{ __("check it out!") }}</a>
      </div>
   {% endif %}

   {% include("components/itilobject/mainform_open.html.twig") %}

   <div class="card card-lg">
      <div class="card-header">
         <h3 class="card-title">
            {{ __("Describe the incident or request") }}
         </h3>
      </div>

      <div class="card-body pb-3">
         <div class="row">
            <div class="col-12 col-sm-5">

               {% if delegating|length %}
                  {% set actor_add_form %}
                     <div id="delegate_other{{ rand }}" class="alert alert-info mt-2">
                        {{ item.showActorAddFormOnCreate(
                           constant('CommonITILActor::REQUESTER'),
                           params
                        )|u.truncate(0) }}
                     </div>
                  {% endset %}

                  {{ fields.dropdownYesNo(
                     'nodelegate',
                     params["nodelegate"],
                     __('This ticket concerns me'),
                     base_field_options|merge({
                        'add_field_html': actor_add_form
                     })
                  ) }}

                  {% if config('use_check_pref') and params['nodelegate'] %}
                     <div class="mt-4">
                        {% set personal_information %}
                           <div class="d-inline-flex">
                              <div class="alert alert-info" id="user-info{{ rand }}">
                                 {% set user = 'User'|getFromDB(getLoginUserID()) %}
                                 {% include "components/user/info_card.html.twig" with {
                                    'user': user.fields,
                                    'can_edit': true
                                 } only %}
                              </div>
                           </div>
                        {% endset %}
                        {{ fields.field(
                           '',
                           personal_information,
                           __('Check your personnal information'),
                           base_field_options
                        ) }}
                     </div>
                  {% endif %}
               {% endif %}
            </div>
            <div class="col-12 col-sm-7">
               {{ fields.field(
                  'type',
                  item.dropdownType('type', {
                     'value': params["type"],
                     'width': '100%',
                     'display': false,
                     'on_change': 'this.form.submit()',
                  }|merge(right_field_options)),
                  _n('Type', 'Types', 1),
                  right_field_options
               ) }}

               {% set cat_params = right_field_options|merge({
                  'on_change': 'this.form.submit()',
               }) %}
               {% set condition = {
                  'is_helpdeskvisible': 1
               } %}
               {% if params['type'] == constant("Ticket::INCIDENT_TYPE") %}
                  {% set condition = condition|merge({'is_incident': 1}) %}
               {% elseif params['type'] == constant("Ticket::DEMAND_TYPE") %}
                  {% set condition = condition|merge({'is_request': 1}) %}
               {% endif %}
               {{ fields.dropdownField(
                  'ITILCategory',
                  'itilcategories_id',
                  params["itilcategories_id"],
                  __('Category'),
                  cat_params|merge({'condition': condition}),
               ) }}

               {{ fields.field(
                  'urgency',
                  item.dropdownUrgency({
                     'value': params["urgency"],
                     'width': '100%',
                     'display': false,
                     'required': right_field_options.fields_template.isMandatoryField('urgency'),
                  }),
                  __("Urgency"),
                  right_field_options
               ) }}

               {% if session('glpiactiveprofile')['helpdesk_hardware'] and session('glpiactiveprofile')["helpdesk_item_type"]|length %}
                  {% set associated_items %}
                     <a class="btn btn-sm btn-ghost-secondary mt-2" role="button"
                        id="btn-collapse-items{{ rand }}"
                        aria-expanded="false" aria-controls="collapse-items{{ rand }}"
                        data-bs-toggle="collapse" href="#collapse-items{{ rand }}" >
                        <i class="fas fa-plus"></i>
                     </a>
                     <div class="collapse" id="collapse-items{{ rand }}">
                        {{ Item_Ticket_itemAddForm(item, params|merge({
                           '_canupdate': have_right('ticket', constant('CREATE')),
                           '_tickettemplate': itiltemplate,
                           'display': false,
                        }))|raw }}
                     </div>
                  {% endset %}

                  {{ fields.field(
                     'items_id',
                     associated_items,
                     _n('Associated element', 'Associated elements', getPluralNumber()),
                     right_field_options
                  ) }}
               {% endif %}

               {# {% set observers_field %}
                  <div class="actor_single">
                     {% for index_observer, observer in params['_users_id_observer'] %}
                        {{ item.showFormHelpdeskObserver({
                           '_user_index': index_observer,
                           'show_first': false,
                        }|merge(params)) }}
                     {% endfor %}
                  </div>
               {% endset %}
               {{ fields.field(
                  'urgency',
                  observers_field,
                  _n('Watcher', 'Watchers', getPluralNumber()),
                  right_field_options
               ) }} #}

               {% if not itiltemplate.isHiddenField("_users_id_observer") or not itiltemplate.isHiddenField("_groups_id_observer") %}
                  {% set observer_field %}
                     {# {% include "components/itilobject/actors/field.html.twig" with {
                        'item': item,
                        'actortypeint': constant('CommonITILActor::OBSERVER'),
                        'actortype': 'observer',
                        'entities_id': params['entities_id'],
                        'itiltemplate': itiltemplate,
                        'params': params,
                        'disable_assign_to_me': true,
                        'canupdate': true,
                        'entity_restrict': session('glpiactive_entity'),
                        'returned_itemtypes': ['User'],
                     } only %}
                     <input type="hidden" name="_actors" id="_actors"> #}

                     {% include "components/itilobject/actors/main.html.twig" with {
                        'item': item,
                        'entities_id': params['entities_id'],
                        'itiltemplate': itiltemplate,
                        'field_options': right_field_options,
                        'canupdate': true,
                        'returned_itemtypes': ['User'],
                        'display_actortypes': ['observer'],
                        'display_labels': false,
                        'disable_assign_to_me': true,
                     } %}
                  {% endset %}
                  {{ fields.field(
                     'observer',
                     observer_field,
                     _n("Watcher", "Watchers", getPluralNumber()),
                     right_field_options|merge({
                        required: itiltemplate.isMandatoryField("_users_id_observer") or itiltemplate.isMandatoryField("_groups_id_observer")
                     })
                  ) }}
               {% endif %}

               {{ fields.dropdownField(
                  'Location',
                  'locations_id',
                  params["locations_id"],
                  "Location"|itemtype_name,
                  right_field_options,
               ) }}

               {{ fields.textField(
                  "name",
               params['name'],
                  __('Title'),
                  right_field_options
               ) }}

               {{ fields.textareaField(
                  "content",
                  getSafeHtml(params['content'] ?? "", true, true),
                  __('Description'),
                  right_field_options|merge({
                     'enable_richtext': true,
                     'enable_fileupload': true,
                  })
               ) }}
            </div>
         </div>
      </div>

      <div class="card-footer text-center">
         <button type="submit" class="btn btn-primary" name="add">
            <i class="fas fa-plus"></i>
            <span>{{ __("Submit message") }}</span>
         </button>
      </div>
   </div>

   {% include("components/itilobject/mainform_close.html.twig") %}
</div>

<script type="text/javascript">
$(function () {
   $('#btn-collapse-items{{ rand }}').on('click', function() {
      $(this).hide();
   });

   $('#dropdown_nodelegate{{ rand }}').on('change', function() {
      $('#delegate_other{{ rand }}')
         .html("")
         .load('{{ path("ajax/dropdownDelegationUsers.php") }}', {
            'right': "delegate",
            'nodelegate': true,
            '_users_id_requester': {{ params["_users_id_requester"] }},
            '_users_id_requester_notif': {{ params["_users_id_requester_notif"]|json_encode()|raw }},
            'use_notification': {{ params["_users_id_requester_notif"]["use_notification"] }},
            'entity_restrict':  {{ session("glpiactive_entity") }}
         });
   })

   saveActorsToDom();
});
</script>
