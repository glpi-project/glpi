<div class="itil-timeline">
   {# TODO timeline filter #}

   {% include("components/itilobject/timeline/main_description.html.twig") %}

   {% set status_closed = (item.fields['status'] in item.getClosedStatusArray()) %}

   {% for entry in timeline|reverse %}
      {% set entry_i = entry['item'] %}
      {% set users_id = entry_i['users_id'] %}
      {% set is_private = entry_i['is_private'] ?? false %}
      {% set date_creation = entry_i['date_creation'] ?? entry_i['date'] %}
      {% set date_mod = entry_i['date_mod'] %}
      {% set entry_rand = random() %}

      {# Fix solution type #}
      {% if entry['type'] is same as 'Solution' %}
         {% set entry = entry|merge({'type': 'ITILSolution'}) %}
      {% endif %}

      {% set can_edit_i  = entry_i['can_edit'] %}
      {% set can_promote = entry['type'] == "ITILFollowup" and can_edit_i and not status_closed %}
      {% set is_promoted = can_promote and entry_i['sourceof_items_id'] > 0 %}

      {% set timeline_position = entry_i['timeline_position'] %}
      {% set item_position = 't-left' %}
      {% if timeline_position == constant('CommonITILObject::TIMELINE_LEFT') %}
         {% set item_position = 't-left' %}
      {% elseif timeline_position == constant('CommonITILObject::TIMELINE_MIDLEFT') %}
         {% set item_position = 't-left t-middle' %}
      {% elseif timeline_position == constant('CommonITILObject::TIMELINE_MIDRIGHT') %}
         {% set item_position = 't-right t-middle' %}
      {% elseif timeline_position == constant('CommonITILObject::TIMELINE_RIGHT') %}
         {% set item_position = 't-right' %}
      {% endif %}

      {% set itiltype = entry['itiltype'] is defined ? "ITIL" ~ entry['itiltype'] : entry['type'] %}

      <div class="d-flex">
         <div class="timeline-item mb-4 {{ itiltype }} {{ "right" in item_position ? "ms-auto" : "" }}"
              data-itemtype="{{ entry['type'] }}" data-items-id="{{ entry_i['id'] }}">
            <div class="row">
               <div class="col-auto todo-list-state d-none">
                  {% if entry_i['state'] is constant('Planning::TODO') %}
                     <span class="state state_1" onclick="change_task_state({{ entry_i['id'] }}, this)" title="{{ __('To do') }}"></span>
                  {% elseif entry_i['state'] is constant('Planning::DONE') %}
                     <span class="state state_2" onclick="change_task_state({{ entry_i['id'] }}, this)" title="{{ __('Done') }}"></span>
                  {% endif %}
               </div>

               <div class="col-auto d-flex flex-column user-part {{ "right" in item_position ? "ms-auto ms-0 order-sm-last" : "" }}">
                  {% set avatar_rand = random() %}
                  <span id="timeline-avatar{{ avatar_rand }}">
                     {% include "components/itilobject/user_picture.html.twig" with {'users_id': users_id} only %}
                  </span>
               </div>
               <div class="col-12 col-sm d-flex flex-column content-part">
                  <div class="d-flex ">
                     <div class="d-flex creator">
                        <div class="d-none d-md-block">
                           <strong>{{ User__getLink(users_id, {
                                 'timeline_item': item,
                                 'timeline_subitem': entry
                              }) }}</strong>
                           {% set user = User__getUserName(users_id, 2) %}
                           {{ Html__showToolTip(user['comment'], {
                              'applyto': "timeline-avatar" ~ avatar_rand
                           }) }}
                        </div>

                        <span title="{{ convDateTime(date_creation) }}" class="ms-2 text-muted text-nowrap">
                           {{ time2str(date_creation) }}
                        </span>
                     </div>

                     <div class="d-flex ms-auto timeline-item-buttons">
                        {% if is_private %}
                           <span title="{{ __('Private') }}" class="is-private ms-2">
                              <i class="fas fa-lock" aria-label="{{ __('Private') }}"></i>
                           </span>
                        {% endif %}

                        {% if is_promoted %}
                           <a href="{{ form_path('Ticket', entry_i['sourceof_items_id']) }}"
                              title="{{ __('Followup promoted to a ticket') }}"
                              class="ms-2">
                              <i class="fas code-branch" aria-label="{{ __('Followup promoted to a ticket') }}"></i>
                           </a>
                        {% endif %}

                        {% set actions = {} %}

                        {% if entry_i['can_edit'] and not status_closed and not (entry['type'] in ['Document_Item', 'Assign']) %}
                           {% set edit_btn %}
                              <li>
                                 <a class="dropdown-item edit-timeline-item" href="#">
                                    <i class="fas fa-fw fa-edit"></i>
                                    <span>{{ __("Edit") }}</span>
                                 </a>
                              </li>
                           {% endset %}
                           {% set actions = actions|merge({edit_btn}) %}
                        {% endif %}

                        {% if item.getType() is same as 'Ticket' and entry['type'] is same as 'ITILFollowup' %}
                           {% set promote_btn %}
                              <li>
                                 <a class="dropdown-item" href="{{ form_path('Ticket') ~ "?_promoted_fup_id=" ~ entry_i['id'] }}">
                                    <i class="fas fa-fw fa-code-branch"></i>
                                    <span>{{ __('Promote to Ticket') }}</span>
                                 </a>
                              </li>
                           {% endset %}
                           {% set actions = actions|merge({promote_btn}) %}
                        {% endif %}

                        {% if actions|length %}
                           <div class="dropdown ms-2">
                              <button class="btn btn-sm btn-ghost-secondary timeline-more-actions" type="button" id="more-actions-{{ entry_rand }}" data-bs-toggle="dropdown" aria-expanded="false">
                                 <i class="fas fa-ellipsis-h"></i>
                              </button>
                              <ul class="dropdown-menu" aria-labelledby="more-actions-{{ entry_rand }}">
                                 {% for action in actions %}
                                    {{ action }}
                                 {% endfor %}
                              </ul>
                           </div>
                        {% endif %}
                     </div>
                  </div>
                  <span class="row mt-2 timeline-content flex-grow-1 {{ item_position }} card">
                     <div class="card-body">
                        {% if itiltype is same as 'ITILValidation' %}
                           {% include 'components/itilobject/timeline/form_validation.html.twig' with {'form_mode': 'view'} %}
                        {% elseif itiltype is same as 'ITILTask' %}
                           {% include 'components/itilobject/timeline/form_task.html.twig' with {'form_mode': 'view'} %}
                        {% elseif itiltype is same as 'ITILFollowup' %}
                           {% include 'components/itilobject/timeline/form_followup.html.twig' with {'form_mode': 'view'} %}
                        {% elseif itiltype is same as 'ITILSolution' %}
                           {% include 'components/itilobject/timeline/form_solution.html.twig' with {'form_mode': 'view'} %}
                        {% elseif itiltype is same as 'Document_Item' %}
                           {% include 'components/itilobject/timeline/form_document_item.html.twig' with {'form_mode': 'view'} %}
                        {% else %}
                           <div class="read-only-content">
                              {{ getHtmlToDisplay(entry_i['content']) }}
                           </div>
                        {% endif %}
                        <div class="edit-content collapse">
                           <button class="btn btn-sm btn-ghost-secondary float-end close-edit-content">
                              <i class="fas fa-2x fa-times"></i>
                           </button>
                           <div class="ajax-content">

                           </div>
                        </div>
                     </div>
                  </span>

                  {% if entry_i['users_id_editor'] and date_creation != date_mod %}
                     {% set editor = User__getLink(entry_i['users_id_editor']) %}
                     <div class="text-muted text-end d-none d-md-block" title="{{ convDateTime(date_mod) }}">
                        {{ __('Last edition: %1$s by %2$s')|format(time2str(date_mod), editor)|raw }}
                     </div>
                  {% endif %}
               </div>
            </div>
         </div>
      </div>
   {% endfor %}

   {# TODO content hidden in template #}
   {% include("components/itilobject/answer.html.twig") %}

</div>

<script type="text/javascript">
$(function() {
   $(document).on("click", ".edit-timeline-item", function() {
      var timeline_item = $(this).closest(".timeline-item");
      var content_block = timeline_item.find(".timeline-content");
      var itemtype      = timeline_item.data('itemtype');
      var items_id      = timeline_item.data('items-id');

      content_block.find(".read-only-content").hide();
      content_block.find(".edit-content").show()
         .find(".ajax-content")
         .html("<i class='fas fa-3x fa-spinner fa-spin ms-auto'></i>")
         .load("{{ path('/ajax/timeline.php') }}", {
            'action'    : 'viewsubitem',
            'type'      : itemtype,
            'parenttype': '{{ item.getType() }}',
            '{{ item.getType()|get_foreignkey_field }}': {{ item.fields['id'] }},
            'id'        : items_id
         });

      $("#itil-footer").find(".main-actions").hide();

      // scroll to edited element
      $("#itil-object-container .itil-left-side").animate(
         { scrollTop:  timeline_item.offset().top }, 'slow',
      );
   });

   $(document).on("click", ".close-edit-content", function() {
      $(this)
         .siblings('.ajax-content').html('')
         .closest('.edit-content').hide()
         .siblings('.read-only-content').show();

      $("#itil-footer .main-actions").show();
   });
});
</script>
